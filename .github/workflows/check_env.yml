name: eBPF LSM Test

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  test-lsm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Enable Host KVM Access (Hardware Acceleration)
        run: sudo chmod 666 /dev/kvm

      - name: Set up Go (Required to install LVH CLI for building)
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install libguestfs and QEMU (Required for building images)
        run: |
          sudo apt-get update
          sudo apt-get install -y libguestfs-tools qemu-system-x86 qemu-utils mmdebstrap debian-archive-keyring
          sudo apt-get remove -y passt || true
          sudo apt-get install -y slirp4netns

      - name: Install LVH CLI
        run: |
          echo "Compiling lvh from source..."
          go install github.com/cilium/little-vm-helper/cmd/lvh@latest
          
          echo "Moving lvh to /usr/local/bin so sudo can find it..."
          sudo mv $(go env GOPATH)/bin/lvh /usr/local/bin/
          
          # Verify sudo can see it
          sudo lvh --help > /dev/null && echo "âœ… LVH installed successfully!"

      # --- THE MAGIC HAPPENS HERE ---
      - name: Cache LVH Built Image
        id: cache-lvh
        uses: actions/cache@v4
        with:
          # We tell GitHub to cache the output directory where LVH saves the image
          path: .lvh/images/
          # The cache key is tied to the hash of your images.json. 
          # If you change the JSON, the hash changes, and GitHub forces a rebuild.
          key: lvh-image-${{ hashFiles('.lvh/images.json') }}

      - name: Build VM Image (Only on Cache Miss)
        if: steps.cache-lvh.outputs.cache-hit != 'true'
        run: |
          echo "Cache missed or images.json changed. Building fresh image..."
          sudo -E lvh images build --dir .lvh
      # ------------------------------

      - name: Get Host Kernel Path
        id: kernel
        run: echo "path=/boot/vmlinuz-$(uname -r)" >> $GITHUB_OUTPUT

      - name: Run BPF Tests inside LVH
        uses: cilium/little-vm-helper@main
        with:
          test-name: 'bpf-lsm-test'
          # Point the Action directly to our freshly built (or cached) image
          image: '.lvh/images/bpf-lsm-tester.qcow2'
          
          # Use the runner's kernel, but inject the crucial BPF LSM boot parameters
          kernel: ${{ steps.kernel.outputs.path }}
          kernel-args: 'lsm=bpf,apparmor root=/dev/sda rw console=ttyS0'
          
          host-mount: '.'
          # Skip provisioning since our image is already fully configured
          provision: 'false' 
          
          cmd: |
            set -ex
            echo "--- Inside the VM ---"
            echo "Kernel: $(uname -r)"
            echo "Active LSMs: $(cat /sys/kernel/security/lsm)"
            
            cd /host
            echo "Workspace contents:"
            ls -la
            
            # TODO: Add your compilation and bpftool load commands here
            # make
            # sudo bpftool prog load ./my_policy.o /sys/fs/bpf/test