name: eBPF LSM Test

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  test-lsm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Enable Host KVM Access (Hardware Acceleration)
        run: sudo chmod 666 /dev/kvm

      - name: Set up Go (Required to install LVH CLI for building)
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libguestfs-tools qemu-system-x86 qemu-utils mmdebstrap debian-archive-keyring
          
          # Fix for Ubuntu 24.04 AppArmor namespace restrictions
          sudo apt-get remove -y passt || true
          sudo apt-get install -y slirp4netns

      - name: Install LVH CLI
        run: |
          echo "Compiling lvh from source..."
          go install github.com/cilium/little-vm-helper/cmd/lvh@latest
          
          echo "Moving lvh to /usr/local/bin so sudo can find it..."
          sudo mv $(go env GOPATH)/bin/lvh /usr/local/bin/
          
          # Verify sudo can see it
          sudo lvh --help > /dev/null && echo "✅ LVH installed successfully!"

      - name: Restore LVH Image Cache
        id: cache-lvh-restore
        uses: actions/cache/restore@v4
        with:
          path: .lvh/images/
          key: lvh-image-${{ hashFiles('.lvh/images.json') }}

      - name: Build VM Image
        if: steps.cache-lvh-restore.outputs.cache-hit != 'true'
        run: |
          echo "Cache missed or images.json changed. Building fresh image..."
          sudo -E lvh images build --dir .lvh

      - name: Save LVH Image Cache
        if: steps.cache-lvh-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: .lvh/images/
          key: lvh-image-${{ hashFiles('.lvh/images.json') }}

      - name: Boot the VM with BPF LSM
        run: |
          echo "Booting LVH VM in the background..."

          # We use the raw CLI here because it supports --kernel-args
          sudo lvh run \
            --image .lvh/images/bpf-lsm-tester.qcow2 \
            --host-mount $(pwd) \
            --daemonize \
            -p 2222:22

          echo "Waiting for the guest SSH daemon to respond..."
          # The smart wait loop to prevent "Connection Refused"
          while ! nc -w 1 localhost 2222 | grep -q "SSH"; do
            sleep 2
          done
          echo "✅ SSH is up and ready!"

      - name: Run BPF Tests inside VM
        run: |
          echo "--- Executing tests inside the VM ---"

          # SSH into the VM and run the test payload
          ssh -p 2222 -o StrictHostKeyChecking=no root@localhost << 'EOF'
            set -ex

            echo "Kernel: $(uname -r)"
            echo "Active LSMs: $(cat /sys/kernel/security/lsm)"

            # The CLI --host-mount flag maps your GitHub workspace to /host
            cd /host
            echo "Workspace contents:"
            ls -la

            # TODO: Your actual build and load commands go here!
            # make clean && make
            # bpftool prog load ./my_policy.o /sys/fs/bpf/test
          EOF