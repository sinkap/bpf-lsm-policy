name: eBPF LSM Test

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  test-bpf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Enable Nested VM Support (KVM)
        # This single line is what allows QEMU to pass hardware acceleration 
        # to the guest VM so it boots in seconds.
        run: sudo chmod 666 /dev/kvm

      - name: Run BPF Tests in LVH
        uses: cilium/little-vm-helper@main
        with:
          test-name: 'lsm-test'
          image: 'kind'
          image-version: 'bpf-next' 
          host-mount: '.'
          install-dependencies: 'true'
          cmd: |
            set -ex
            
            echo "--- Booted inside the LVH VM! ---"
            echo "Kernel Version: $(uname -r)"
            echo "Active LSMs: $(cat /sys/kernel/security/lsm)"

            # The Action mounts your GitHub workspace here
            cd /host
            
            # TODO: Your actual build and load commands go here
            # make clean && make
            # bpftool prog load ./my_lsm_policy.o /sys/fs/bpf/policy