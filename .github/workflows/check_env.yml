name: BPF LSM Test Environment

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  test-bpf-policy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check User and Root Access
        run: |
          echo "--- Sudo Access ---"
          sudo whoami

      - name: Check BTF (BPF Type Format) Support
        run: |
          echo "Looking for /sys/kernel/btf/vmlinux..."
          if [ -f /sys/kernel/btf/vmlinux ]; then
            echo "✅ BTF is available!"
          else
            echo "❌ BTF not found. Exiting."
            exit 1
          fi

      - name: Check Kernel Config for BPF LSM (Compiled)
        run: |
          echo "Checking /boot/config-$(uname -r) for LSM configs..."
          grep -E "CONFIG_BPF_LSM|CONFIG_LSM=" /boot/config-$(uname -r) || true

      - name: Check Active LSMs (Runtime)
        run: |
          echo "Checking active LSMs in /sys/kernel/security/lsm..."
          ACTIVE_LSMS=$(cat /sys/kernel/security/lsm)
          echo "Active LSMs: $ACTIVE_LSMS"

          if [[ "$ACTIVE_LSMS" == *"bpf"* ]]; then
            echo "✅ BPF is active in the LSM chain!"
          else
            echo "❌ BPF is NOT active in the LSM chain."
            echo "Cannot attach BPF LSM programs on this kernel."
            exit 1
          fi
