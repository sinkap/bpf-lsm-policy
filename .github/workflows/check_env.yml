name: BPF LSM VM Env Check

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  check-env-in-vm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Boot Custom VM and Check Environment
        # This action boots an Ubuntu VM inside the GitHub Runner
        uses: vmactions/ubuntu-vm@v1
        with:
          envs: 'GITHUB_WORKSPACE'
          # Force BPF into the active LSM chain on boot
          append-kernel-args: "lsm=landlock,lockdown,yama,integrity,apparmor,bpf"
          usesh: true
          # The run block executes INSIDE the booted VM as root
          run: |
            set -e
            
            echo "========================================"
            echo "1. Checking Active LSMs"
            echo "========================================"
            ACTIVE_LSMS=$(cat /sys/kernel/security/lsm)
            echo "Active LSMs: $ACTIVE_LSMS"
            
            if [[ "$ACTIVE_LSMS" == *"bpf"* ]]; then
              echo "✅ BPF IS ACTIVE!"
            else
              echo "❌ BPF is NOT active. Exiting."
              exit 1
            fi
            
            echo ""
            echo "========================================"
            echo "2. Checking BTF (BPF Type Format)"
            echo "========================================"
            if [ -f /sys/kernel/btf/vmlinux ]; then
              echo "✅ BTF is available!"
              ls -lh /sys/kernel/btf/vmlinux
            else
              echo "❌ BTF not found at /sys/kernel/btf/vmlinux."
              exit 1
            fi
            
            echo ""
            echo "========================================"
            echo "3. Checking Nested KVM Availability"
            echo "========================================"
            if [ -r /dev/kvm ]; then
              echo "✅ /dev/kvm exists inside the VM."
            else
              echo "❌ /dev/kvm NOT found inside the VM."
            fi
            
            echo "Installing cpu-checker to verify nested virtualization..."
            apt-get update -qq
            apt-get install -y -qq cpu-checker
            
            echo "Running kvm-ok..."
            kvm-ok || true