name: BPF LSM Test Environment

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  test-bpf-policy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- NEW: Check Permissions ---
      - name: Check User and Root Access
        run: |
          echo "--- Current User ---"
          whoami
          id
          
          echo "--- Sudo Access ---"
          # GitHub Actions runners run as the 'runner' user, but have passwordless sudo.
          sudo whoami
          sudo id

      # --- NEW: Check BTF Support ---
      - name: Check BTF (BPF Type Format) Support
        run: |
          echo "Looking for /sys/kernel/btf/vmlinux..."
          if [ -f /sys/kernel/btf/vmlinux ]; then
            echo "✅ BTF is available!"
            ls -lh /sys/kernel/btf/vmlinux
          else
            echo "❌ BTF not found at /sys/kernel/btf/vmlinux."
            echo "Your BPF CO-RE programs might fail to load."
            exit 1
          fi

      # Optional but recommended: Check if the runner kernel actually has BPF LSM enabled
      - name: Check Kernel Config for BPF LSM
        run: |
          grep -E "CONFIG_BPF_LSM|CONFIG_LSM=" /boot/config-$(uname -r) || echo "Warning: Could not read config."
          cat /sys/kernel/security/lsm

      - name: Check KVM Availability
        run: |
          echo "Checking KVM..."
          ls -l /dev/kvm || true
          sudo apt-get update && sudo apt-get install -y cpu-checker
          sudo kvm-ok || true