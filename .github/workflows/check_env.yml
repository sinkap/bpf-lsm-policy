name: eBPF LSM Test

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  test-lsm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Enable Host KVM Access (Hardware Acceleration)
        run: sudo chmod 666 /dev/kvm

      - name: Set up Go (Required to install LVH CLI for building)
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libguestfs-tools qemu-system-x86 qemu-utils mmdebstrap debian-archive-keyring

          # Fix for Ubuntu 24.04 AppArmor namespace restrictions
          sudo apt-get remove -y passt || true
          sudo apt-get install -y slirp4netns

      - name: Install LVH CLI
        run: |
          echo "Compiling lvh from source..."
          go install github.com/cilium/little-vm-helper/cmd/lvh@latest

          echo "Moving lvh to /usr/local/bin so sudo can find it..."

          # Verify sudo can see it
          sudo lvh --help > /dev/null && echo "‚úÖ LVH installed successfully!"

      - name: Restore LVH Image Cache
        id: cache-lvh-restore
        uses: actions/cache/restore@v4
        with:
          path: .lvh/images/
          key: lvh-image-${{ hashFiles('.lvh/images.json', '.lvh/scripts/*.sh') }}

      - name: Build VM Image
        if: steps.cache-lvh-restore.outputs.cache-hit != 'true'
        run: |
          echo "Cache missed. Building fresh image..."
          sudo -E lvh images build --dir .lvh

      - name: Save LVH Image Cache
        if: steps.cache-lvh-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: .lvh/images/
          # Must match the restore key exactly!
          key: lvh-image-${{ hashFiles('.lvh/images.json', '.lvh/scripts/*.sh') }}

      - name: Boot the VM with BPF LSM
        run: |
          echo "Booting LVH VM in the background..."

          # We use the raw CLI here because it supports --kernel-args
          sudo lvh run \
            --image .lvh/images/bpf-lsm-tester.qcow2 \
            --host-mount $(pwd) \
            --cpu-kind host \
            --daemonize \
            -p 2222:22

          echo "Waiting for the guest SSH daemon to respond..."
          # The smart wait loop to prevent "Connection Refused"
          while ! nc -w 1 localhost 2222 | grep -q "SSH"; do
            sleep 2
          done
          echo "‚úÖ SSH is up and ready!"

      - name: Verify KVM and eBPF Environment
        run: |

          echo "::group::üêß Connect to VM and Run Internal Checks"
          # Run the internal checks and wrap their outputs in groups too!
          ssh -p 2222 -o StrictHostKeyChecking=no root@localhost << 'EOF'
            set -ex

            echo "::group::üîí BPF LSM Check"
            ACTIVE_LSMS=$(cat /sys/kernel/security/lsm)
            echo "Found active LSMs: $ACTIVE_LSMS"
            if [[ "$ACTIVE_LSMS" == *"bpf"* ]]; then
              echo "‚úÖ BPF LSM is active."
            else
              echo "‚ùå BPF LSM is missing"
              exit 1
            fi
            echo "::endgroup::"

            echo "::group::üöÄ Nested KVM Check"
            if [ -c /dev/kvm ]; then
              echo "‚úÖ /dev/kvm is present inside the VM!"
            else
              echo "‚ùå /dev/kvm is missing inside the guest"
              exit 1
            fi
            echo "::endgroup::"

            echo "::group::üóÉÔ∏è BTF vmlinux Check"
            if [ -f /sys/kernel/btf/vmlinux ]; then
              echo "‚úÖ BTF vmlinux is present at /sys/kernel/btf/vmlinux."
            else
              echo "‚ùå BTF vmlinux is missing"
              exit 1
            fi
            echo "::endgroup::"

            echo "::group::üìÅ Workspace Mount Check"
            cd /host
            echo "Successfully mounted /host. Contents:"
            ls -la
            echo "::endgroup::"
          EOF
          echo "::endgroup::"