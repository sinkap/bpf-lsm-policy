name: Check KVM Availability

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Allows you to trigger this manually from the GitHub UI

jobs:
  check-kvm:
    runs-on: ubuntu-latest

    steps:
      - name: Check /dev/kvm existence
        run: |
          echo "Looking for /dev/kvm..."
          # We use '|| true' so the workflow doesn't fail if the file is missing
          ls -l /dev/kvm || echo "❌ /dev/kvm does NOT exist on this runner."

      - name: Install cpu-checker
        run: sudo apt-get update && sudo apt-get install -y cpu-checker

      - name: Check KVM Hardware Support (kvm-ok)
        run: |
          echo "Running kvm-ok..."
          sudo kvm-ok || echo "❌ Hardware virtualization is NOT supported."

      - name: Show CPU Virtualization Flags
        run: |
          echo "Checking CPU flags for vmx (Intel) or svm (AMD)..."
          grep -E -c '(vmx|svm)' /proc/cpuinfo || echo "❌ No virtualization flags found."